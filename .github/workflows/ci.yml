name: autogreen-generate

on:
  schedule:
    - cron: "0 0 * * *" # 每天 00:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Git identity
        run: |
          git config --global user.name "Kitamori"
          git config --global user.email "langlede233@gmail.com"

      - name: Generate random times (UTC)
        id: gen
        env:
          TOKEN: ${{ secrets.MY_TOKEN }}
        run: |
          COUNT=$(( (RANDOM % 5) + 1 ))
          TIMES=()
          while [ ${#TIMES[@]} -lt $COUNT ]; do
            H=$(( RANDOM % 24 ))
            M=$(( RANDOM % 60 ))
            T=$(printf "%02d:%02d" $H $M)
            skip=0
            for e in "${TIMES[@]}"; do
              if [ "$e" = "$T" ]; then skip=1; break; fi
            done
            [ $skip -eq 0 ] && TIMES+=("$T")
          done
          IFS=$'\n' sorted=($(sort <<<"${TIMES[*]}"))
          unset IFS
          mkdir -p .github
          echo '{ "date": "'$(date -u +%Y-%m-%d)'", "times": [' > .github/autogreen-schedule.json
          first=1
          for t in "${sorted[@]}"; do
            if [ $first -eq 1 ]; then first=0; else echo ',' >> .github/autogreen-schedule.json; fi
            echo -n "  {\"time\":\"$t\",\"done\":false}" >> .github/autogreen-schedule.json
          done
          echo '' >> .github/autogreen-schedule.json
          echo '] }' >> .github/autogreen-schedule.json

          git add .github/autogreen-schedule.json
          git commit -m "chore(autogreen): generate today's schedule" || echo "no changes"
          
          git remote set-url origin "https://${{ github.actor }}:${TOKEN}@github.com/${{ github.repository }}"

          git push origin HEAD:master || echo "push failed"
